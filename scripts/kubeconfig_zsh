#!/usr/bin/env zsh

[[ -n $DEBUG ]] && set -x

configs_dir=~/.kube/configs

# Функции
list_configs() {
    ls ~/.kube/configs/*.yml 2>/dev/null || echo "No config files found in ~/.kube/configs/"
}

set_config() {
    local config_file=~/.kube/configs/$1.yml
    if [[ -f "$config_file" ]]; then
        export KUBECONFIG="$config_file"
        echo "✓ KUBECONFIG set to: $config_file"
    else
        echo "✗ Config file not found: $config_file" >&2
        return 1
    fi
}

choose_config_interactive() {
    # Проверяем наличие fzf
    if ! command -v fzf &> /dev/null; then
        echo "fzf is not installed. Please install it first." >&2
        list_configs
        return 1
    fi

    # Получаем список конфигов
    local configs=($(basename -s .yml ~/.kube/configs/*.yml 2>/dev/null))
    
    if [[ ${#configs[@]} -eq 0 ]]; then
        echo "No config files found in ~/.kube/configs/" >&2
        return 1
    fi

    # Выбор через fzf
    local choice
    choice=$(printf "%s\n" "${configs[@]}" | fzf --height=40% --border --prompt="Select kubeconfig: ")
    
    if [[ -z "$choice" ]]; then
        echo "No selection made." >&2
        return 1
    fi
    
    set_config "$choice"
}

kubeconfig() {
    case $# in
        0)
            if command -v fzf &> /dev/null; then
                choose_config_interactive
            else
                list_configs
            fi
            ;;
        1)
            if [[ "$1" == "--help" || "$1" == "-h" ]]; then
                echo "Usage:"
                echo "  kubeconfig                 - list or select config (interactive if fzf available)"
                echo "  kubeconfig <config-name>   - set specific config"
                echo "  kubeconfig --list          - list all configs"
                echo "  kubeconfig --help          - show this help"
                return 0
            elif [[ "$1" == "--list" || "$1" == "-l" ]]; then
                list_configs
                return 0
            else
                set_config "$1"
            fi
            ;;
        *)
            echo "Usage: kubeconfig [<config-name>|--list|--help]" >&2
            return 1
            ;;
    esac
}

# Автодополнение для Zsh
_kubeconfig_completion() {
    local -a configs
    configs=($(basename -s .yml ~/.kube/configs/*.yml 2>/dev/null))
    
    _arguments \
        "1: :($configs --list --help)" \
        "--list[List all configs]" \
        "--help[Show help]"
}

compdef _kubeconfig_completion kubeconfig

